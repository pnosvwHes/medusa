{% extends "app/base.html" %}
{% load humanize %}
{% load jalali_tags %}

{% block content %}
<h2 class="mb-4 text-center">ثبت تراکنش جدید</h2>

<form method="post" novalidate>
    {% csrf_token %}
    <div class="form-grid" style="display: grid; grid-template-columns: 1fr 1fr; gap: 1rem;">
        <div class="row-1" style="grid-column: 1 / -1; display: flex; gap: 1rem;">
            <div class="flex-grow-1" style="flex:1;">
                {{ form.date.label_tag }}<br>
                {{ form.date }}
                {% if form.date.errors %}
                    <div class="text-danger">{{ form.date.errors }}</div>
                {% endif %}
            </div>
            <div class="flex-grow-1" style="flex:1;">
                {{ form.transaction_type.label_tag }}<br>
                {{ form.transaction_type }}
                {% if form.transaction_type.errors %}
                    <div class="text-danger">{{ form.transaction_type.errors }}</div>
                {% endif %}
            </div>
        </div>

        <div class="row-2" style="grid-column: 1 / -1; display: flex; gap: 1rem; flex-wrap: wrap;">
            <div class="flex-grow-1" style="flex:1;">
                {{ form.source_type.label_tag }}<br>
                {{ form.source_type }}
                {% if form.source_type.errors %}
                    <div class="text-danger">{{ form.source_type.errors }}</div>
                {% endif %}
            </div>
            <div class="flex-grow-1" id="bank-container" style="flex:1; display:none;">
                {{ form.bank.label_tag }}<br>
                {{ form.bank }}
                {% if form.bank.errors %}
                    <div class="text-danger">{{ form.bank.errors }}</div>
                {% endif %}
            </div>
            <div class="flex-grow-1" style="flex:1;">
                {{ form.amount.label_tag }}<br>
                {{ form.amount }}
                {% if form.amount.errors %}
                    <div class="text-danger">{{ form.amount.errors }}</div>
                {% endif %}
            </div>
        </div>

        <div style="grid-column: 1 / -1; margin-top: 1rem;">
            {{ form.description.label_tag }}<br>
            {{ form.description }}
            {% if form.description.errors %}
                <div class="text-danger">{{ form.description.errors }}</div>
            {% endif %}
        </div>
    </div>

    <button type="submit" class="btn btn-primary mt-3">ثبت</button>
</form>
<script>
    function toggleBankField() {
        let selectedOption = $("#id_source_type option:selected");
        let requiresBank = selectedOption.data('requires-bank');
        if (requiresBank === true || requiresBank === "true") {
            $("#bank-container").show();
            $("#id_bank").show();
        } else {
            $("#bank-container").hide();
            $("#id_bank").hide();
            $("#id_bank").val('');
        }
    }

    $(document).ready(function () {
        toggleBankField();
        $("#id_source_type").change(function () {
            toggleBankField();
        });

        $("#id_amount").on('input', function () {
            let val = $(this).val().replace(/,/g, '');
            if ($.isNumeric(val)) {
                let formatted = Number(val).toLocaleString('en-US');
                $(this).val(formatted);
            } else if (val === '') {
                $(this).val('');
            } else {
                $(this).val(val.replace(/[^\d]/g, ''));
            }
        });
    });
</script>

{% endblock %}

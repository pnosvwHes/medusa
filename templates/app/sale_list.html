{% extends "app/base.html" %}
{% load humanize %}
{% load jalali_tags %}

{% block content %}
<div class="max-w-6xl mx-auto p-6">

    <!-- هدر -->
    <div class="flex justify-between items-center mb-6">
        <h2 class="text-xl font-bold text-gray-800">لیست فاکتورها</h2>
        <a href="{% url 'create_sale' %}" 
           class="bg-indigo-500 text-white px-4 py-2 rounded-xl shadow hover:bg-indigo-600 transition text-sm">
            فاکتور جدید
        </a>
    </div>

    <!-- فرم فیلتر تاریخ -->
    <form method="get" 
          class="mb-6 bg-white shadow-md rounded-2xl border border-gray-200 p-4 flex flex-wrap items-end gap-4">

        <div>
            <label for="filter_date" class="block mb-1 text-gray-700 text-sm font-semibold">تاریخ</label>

            <input type="text" 
                   id="filter_date"
                   name="date"
                   class="datepicker border rounded-lg px-3 py-2 w-40 text-sm focus:ring focus:ring-blue-300"
                   autocomplete="off"
                   placeholder="تاریخ را انتخاب کنید"
                   value="{% if selected_jalali_date %}{{ selected_jalali_date }}{% elif request.GET.date %}{{ request.GET.date }}{% endif %}">
        </div>

        <div>
            <button type="submit"
                class="bg-indigo-500 text-white px-5 py-2 rounded-xl shadow hover:bg-indigo-600 transition">
                فیلتر
            </button>
        </div>
    </form>


    <!-- کارت جمع کل -->
    <div class="flex flex-col md:flex-row gap-4 mb-6">
        <div class="bg-white shadow-md rounded-2xl p-4 flex-1">
            <p class="text-gray-600">جمع کل فاکتورها</p>
            <p class="text-indigo-600 font-bold text-lg">{{ total_price|intcomma }}</p>
        </div>
        <div class="bg-white shadow-md rounded-2xl p-4 flex-1">
            <p class="text-gray-600">جمع کمیسیون‌ها</p>
            <p class="text-indigo-600 font-bold text-lg">{{ total_commission|intcomma }}</p>
        </div>
    </div>


    <!-- دسکتاپ -->
    <div class="hidden md:block overflow-x-auto bg-white shadow-md rounded-2xl border border-gray-200">
        <table class="w-full text-sm text-right text-gray-700">
            <thead class="bg-gradient-to-r from-blue-500 to-indigo-500 text-white text-lg">
                <tr>
                    <th class="px-4 py-3 text-center">تاریخ</th>
                    <th class="px-4 py-3 text-center">مشتری</th>
                    <th class="px-4 py-3 text-center">پرسنل</th>
                    <th class="px-4 py-3 text-center">خدمت</th>
                    <th class="px-4 py-3 text-center">مبلغ</th>
                    <th class="px-4 py-3 text-center">کمیسیون</th>
                    <th class="px-4 py-3 text-center">عملیات</th>
                </tr>
            </thead>
            <tbody class="divide-y divide-gray-100">
                {% for sale in sales %}
                <tr class="hover:bg-gray-50 transition">
                    <td class="px-4 py-3 text-gray-600">{{ sale.date|to_jalali:'%Y/%m/%d' }}</td>
                    <td class="px-4 py-3">{{ sale.customer }}</td>
                    <td class="px-4 py-3">{{ sale.personnel }}</td>
                    <td class="px-4 py-3">{{ sale.work }}</td>
                    <td class="px-4 py-3 font-semibold text-indigo-600">{{ sale.price|intcomma }}</td>
                    <td class="px-4 py-3 font-semibold text-indigo-600">{{ sale.commission_amount|intcomma }}</td>
                    <td class="px-4 py-3 flex justify-center gap-3">
                        <a href="{% url 'sale_images' sale.id %}" class="text-gray-700 hover:text-gray-900">
                            <i class="fas fa-images"></i>
                        </a>
                        <a href="{% url 'update_sale' sale.id %}" class="text-blue-500 hover:text-blue-700">
                            <i class="fas fa-edit"></i>
                        </a>
                        <a href="{% url 'delete_sale' sale.id %}" class="text-red-500 hover:text-red-700">
                            <i class="fas fa-trash"></i>
                        </a>
                    </td>
                </tr>
                {% empty %}
                <tr>
                    <td colspan="7" class="text-center py-6 text-gray-500">هیچ فاکتوری ثبت نشده است ✨</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- موبایل -->
    <div class="md:hidden space-y-3">
        {% for sale in sales %}
        <div class="relative bg-white shadow rounded-lg border border-gray-200 overflow-hidden">
            <div class="swipe-card relative bg-white p-3 transition-transform duration-300">
                <div class="flex justify-between items-start mb-2">
                    <div class="flex flex-col gap-1">
                        <span class="text-gray-500 text-sm">{{ sale.date|to_jalali:'%Y/%m/%d' }}</span>
                        <span class="text-gray-800 font-semibold text-sm">
                            {{ sale.customer }} - {{ sale.personnel }}
                        </span>
                    </div>

                    <div class="flex flex-col items-end gap-1">
                        <span class="px-2 py-1 text-xs rounded-full border border-gray-300 bg-gray-50 text-gray-700">
                            مبلغ: {{ sale.price|intcomma }}
                        </span>
                        <span class="px-2 py-1 text-xs rounded-full border border-gray-300 bg-gray-50 text-gray-700">
                            کمیسیون: {{ sale.commission_amount|intcomma }}
                        </span>
                    </div>
                </div>

                <div class="text-indigo-600 font-bold text-base">
                    {{ sale.work }}
                </div>
            </div>
        </div>
        {% empty %}
        <p class="text-center py-6 text-gray-500">هیچ فاکتوری ثبت نشده است ✨</p>
        {% endfor %}
    </div>

</div>
{% endblock %}


{% block extra_scripts %}
<script>
document.addEventListener("DOMContentLoaded", function () {

    /* اصلاح تاریخ قبل از ارسال */
    const form = document.querySelector("form");
    form.addEventListener("submit", function () {
        let d = document.getElementById("filter_date").value;
        if (d) {
            document.getElementById("filter_date").value = d.replace(/\//g, "-");
        }
    });

});
</script>
{% endblock %}

<!-- templates/gallery/gallery.html -->
{% extends 'app/base.html' %}

{% block content %}
<div class="container mt-4">
    <h2>گالری عکس‌های فاکتور</h2>
    
    <!-- فیلترها -->
    <div class="card mb-4">
        <div class="card-body">
            <form method="get" class="row g-3">
                <div class="col-md-4">
                    <label for="customer" class="form-label">مشتری:</label>
                    <select name="customer" id="customer" class="form-select">
                        <option value="">همه مشتریان</option>
                        {% for customer in customers %}
                            <option value="{{ customer.id }}" {% if selected_customer == customer.id|stringformat:"s" %}selected{% endif %}>
                                {{ customer.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                
                {% if user.is_superuser %}
                <div class="col-md-4">
                    <label for="personnel" class="form-label">پرسنل:</label>
                    <select name="personnel" id="personnel" class="form-select">
                        <option value="">همه پرسنل</option>
                        {% for personnel in personnel_list %}
                            <option value="{{ personnel.id }}" {% if selected_personnel == personnel.id|stringformat:"s" %}selected{% endif %}>
                                {{ personnel.name }}
                            </option>
                        {% endfor %}
                    </select>
                </div>
                {% endif %}
                
                <div class="col-md-4">
                    <label class="form-label">&nbsp;</label>
                    <div>
                        <button type="submit" class="btn btn-primary">اعمال فیلتر</button>
                        <a href="{% url 'gallery' %}" class="btn btn-secondary">پاک کردن فیلترها</a>
                    </div>
                </div>
            </form>
        </div>
    </div>
    
    <!-- نمایش عکس‌ها -->
    <div class="row">
        {% for image in images %}
            <div class="col-6 col-md-3 mb-3">
                <div class="card">
                    <img src="{{ image.image.url }}" class="card-img-top gallery-img" alt="عکس فاکتور" style="height: 120px; object-fit: cover; cursor: pointer;">
                    <div class="card-body p-2">
                        <p class="card-text" style="font-size: 0.8rem;">
                            مشتری: {{ image.sale.customer.name }}<br>
                            پرسنل: {{ image.sale.personnel.name }}<br>
                            تاریخ: {{ image.uploaded_at|date:"Y/m/d" }}
                        </p>
                    </div>
                </div>
            </div>
        {% empty %}
            <div class="col-12">
                <div class="alert alert-info text-center">
                    هیچ عکسی یافت نشد.
                </div>
            </div>
        {% endfor %}
    </div>
</div>

<!-- مودال نمایش عکس -->
<div id="imageModal" class="fixed inset-0 bg-black bg-opacity-80 hidden z-50 flex items-center justify-center">
  <div class="relative max-w-full max-h-full overflow-hidden">
    <img id="modalImage" class="max-w-full max-h-full transform transition-transform duration-200" />
  </div>
</div>

<script>
  const modal = document.getElementById("imageModal");
  const modalImage = document.getElementById("modalImage");

  let scale = 1;
  let startDistance = 0;

  // باز کردن مودال
  document.querySelectorAll(".gallery-img").forEach(img => {
    img.addEventListener("click", () => {
      modal.classList.remove("hidden");
      modalImage.src = img.src;
      scale = 1;
      modalImage.style.transform = "scale(1)";
    });
  });

  // بستن مودال با کلیک بیرون
  modal.addEventListener("click", e => {
    if (e.target === modal) modal.classList.add("hidden");
  });

  // پینچ برای زوم
  modalImage.addEventListener("touchstart", e => {
    if (e.touches.length === 2) {
      const dx = e.touches[0].clientX - e.touches[1].clientX;
      const dy = e.touches[0].clientY - e.touches[1].clientY;
      startDistance = Math.sqrt(dx*dx + dy*dy);
    }
  });

  modalImage.addEventListener("touchmove", e => {
    if (e.touches.length === 2) {
      const dx = e.touches[0].clientX - e.touches[1].clientX;
      const dy = e.touches[0].clientY - e.touches[1].clientY;
      const newDistance = Math.sqrt(dx*dx + dy*dy);
      let newScale = scale * (newDistance / startDistance);
      newScale = Math.min(Math.max(1, newScale), 4); // محدود به 1 تا 4 برابر
      modalImage.style.transform = `scale(${newScale})`;
    }
  });

  modalImage.addEventListener("touchend", e => {
    if (e.touches.length < 2) {
      scale = parseFloat(modalImage.style.transform.replace("scale(", "").replace(")", "")) || 1;
    }
  });
</script>
{% endblock %}

{% extends "app/base.html" %}
{% load humanize %}
{% block content %}
{% load form_tags %}

<div class="flex justify-center items-center min-h-screen form-data">
  <div class="form-data w-full max-w-2xl mx-4">
    <h1 class="text-2xl font-bold mb-6 text-center">ویرایش فاکتور</h1>

    <form method="POST" id="saleForm" enctype="multipart/form-data">
      {% csrf_token %}
      <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
        {% for field in form %}
          {% if field.name != 'date' and field.name != 'time' %}
            <div class="flex flex-col md:flex-row md:items-center gap-2">
              <label for="{{ field.id_for_label }}" class="form-label">{{ field.label }}</label>
              <div class="md:w-2/3">
                {% if field.name == 'price' %}
                  <input type="text" name="price" id="{{ field.id_for_label }}" class="form-input price-field" value="{{ field.value|default_if_none:''|intcomma }}">
                  <small class="text-gray-500 price-in-words"></small>
                {% else %}
                  {{ field|add_class:"form-input" }}
                {% endif %}
                {% if field.errors %}
                  <div class="form-error">{{ field.errors.0 }}</div>
                {% endif %}
              </div>
            </div>
          {% endif %}
        {% endfor %}

        <!-- تاریخ و ساعت -->
        <div class="flex flex-col md:flex-row md:items-center gap-2 col-span-1 md:col-span-2">
          <div class="flex-1 flex flex-col md:flex-row md:items-center gap-2">
            <label for="{{ form.date.id_for_label }}" class="form-label">{{ form.date.label }}</label>
            <div class="md:w-2/3">
              {{ form.date|add_class:"form-input" }}
              {% if form.date.errors %}
                <div class="form-error">{{ form.date.errors.0 }}</div>
              {% endif %}
            </div>
          </div>
        </div>

        <!-- عکس‌های فاکتور -->
        <div class="col-span-1 md:col-span-2">
          <label class="form-label mb-2">عکس‌های فاکتور</label>
          <div id="imageContainer" class="grid grid-cols-2 gap-4 items-start">

            <!-- کارت قبل -->
            {% if before_images %}
              <div class="relative border border-gray-300 rounded p-2 flex flex-col items-center justify-center h-32 cursor-pointer" data-type="before">
                <span class="text-gray-400 mb-1">قبل</span>
                <img class="w-full h-full object-cover rounded" src="{{ before_images.0.image.url }}"/>
                <input type="file" accept="image/*" class="hidden imageInput" name="images_before">
              </div>
            {% else %}
              <div class="relative border border-gray-300 rounded p-2 flex flex-col items-center justify-center h-32 cursor-pointer" data-type="before">
                <span class="text-gray-400 mb-1">قبل</span>
                <img class="w-full h-full object-cover rounded hidden"/>
                <input type="file" accept="image/*" class="hidden imageInput" name="images_before">
              </div>
            {% endif %}

            <!-- کارت بعد -->
            {% for img in after_images %}
              <div class="relative border border-gray-300 rounded p-2 flex flex-col items-center justify-center h-32 cursor-pointer" data-type="after">
                <span class="text-gray-400 mb-1">بعد</span>
                <img class="w-full h-full object-cover rounded" src="{{ img.image.url }}"/>
                <input type="file" accept="image/*" class="hidden imageInput" name="images_after">
              </div>
            {% endfor %}

            <!-- کارت اضافه کردن عکس بعد -->
            <div id="addCardBtn" class="flex items-center justify-center border border-gray-300 rounded h-32 text-gray-500 cursor-pointer text-2xl font-bold">
              +
            </div>

          </div>
          <p class="form-help">حداکثر ۴ کارت عکس مجاز است</p>
        </div>

      </div>

      <div class="form-actions">
        <button type="submit" class="button primary">ذخیره فاکتور</button>
      </div>
    </form>
  </div>
</div>

<!-- کتابخانه تبدیل عدد به حروف -->
<script src="https://cdn.jsdelivr.net/npm/num2persian@latest/dist/num2persian.min.js"></script>

<script>
document.addEventListener("DOMContentLoaded", () => {
    // تبدیل عدد به حروف
    const priceFields = document.querySelectorAll(".price-field");
    priceFields.forEach(input => {
        const small = input.nextElementSibling; // assume small right after input

        const updateWords = () => {
            let val = input.value.replace(/,/g, '');
            // اگر مقدار عددی معتبر باشد
            if(val && !isNaN(val)) {
                small.innerText = Num2persian.toWords(parseInt(val));
            } else {
                small.innerText = '';
            }
        }

        // مقدار اولیه
        updateWords();

        // وقتی کاربر تایپ می‌کنه
        input.addEventListener("input", () => {
            // فرمت عدد با کاما
            let numVal = input.value.replace(/,/g,'');
            if(!isNaN(numVal) && numVal.length > 0){
                input.value = parseInt(numVal).toLocaleString('en-US');
            }
            updateWords();
        });
    });

    // مدیریت تصاویر
    const container = $("#imageContainer");
    const addBtn = $("#addCardBtn");

    function setupCard(card) {
        const input = card.find("input");
        const img = card.find("img");

        card.on("click", e => {
            const $t = $(e.target);
            if ($t.is("input") || $t.is("img")) return;
            input[0].click();
        });

        input.on("change", () => {
            if(input[0].files.length > 0){
                const file = input[0].files[0];
                const reader = new FileReader();
                reader.onload = e => { img.attr('src', e.target.result).removeClass('hidden'); };
                reader.readAsDataURL(file);
            }
        });

        img.on("click", e => { e.stopPropagation(); window.open(img.attr('src'),'_blank'); });
    }

    container.children(".relative").each(function(){ setupCard($(this)); });

    function updateAddButton(){
        const afterCount = container.children("[data-type='after']").length;
        addBtn.toggleClass("hidden", afterCount >= 3);
    }

    updateAddButton();

    addBtn.on("click", () => {
        const afterCount = container.children("[data-type='after']").length;
        if(afterCount >= 3) return;
        const newCard = $(`<div class="relative border border-gray-300 rounded p-2 flex flex-col items-center justify-center h-32 cursor-pointer" data-type="after">
                                <span class="text-gray-400 mb-1">بعد</span>
                                <img class="w-full h-full object-cover rounded hidden"/>
                                <input type="file" accept="image/*" class="hidden imageInput" name="images_after">
                            </div>`);
        newCard.insertBefore(addBtn);
        setupCard(newCard);
        updateAddButton();
    });
});
</script>

<style>
#imageContainer .relative { border: 2px dashed #ccc; border-radius: 0.5rem; position: relative; height: 160px; overflow: hidden; }
#imageContainer .relative span { font-size: 1rem; }
#imageContainer img { width: 100%; height: 100%; object-fit: cover; }
.price-in-words { display: block; margin-top: 0.25rem; color: #555; font-size: 0.9rem; }
</style>
{% endblock %}

{% extends "app/base.html" %}
{% load static %}
{% load humanize %}

{% block content %}
<div class="max-w-2xl mx-auto p-4 bg-white rounded-xl shadow-md mt-6">
  <h1 class="text-2xl font-bold text-center mb-6 text-gray-800">ثبت دریافت جدید</h1>
  
  <form method="POST" id="receiptForm" class="space-y-6">
    {% csrf_token %}
    
    <!-- ردیف اول: تاریخ و مبلغ -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="form-group">
        <label for="{{ form.date.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
          {{ form.date.label }}
        </label>
        {{ form.date }}
      </div>

      <div class="form-group">
        <label for="{{ form.amount.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
          {{ form.amount.label }}
        </label>
        {{ form.amount }}
      </div>
    </div>

    <!-- ردیف دوم: نوع منبع و بانک (در صورت نیاز) -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="sourceTypeRow">
      <div class="form-group">
        <label for="{{ form.source_type.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
          {{ form.source_type.label }}
        </label>
        {{ form.source_type }}
      </div>

      <div class="form-group" id="bankField">
        <label for="{{ form.bank.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
          {{ form.bank.label }}
        </label>
        {{ form.bank }}
      </div>
    </div>

    <!-- ردیف سوم: نوع دریافت و مشتری (در صورت نیاز) -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6" id="receiptTypeRow">
      <div class="form-group">
        <label for="{{ form.receipt_type.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
          {{ form.receipt_type.label }}
        </label>
        {{ form.receipt_type }}
      </div>

      <div class="form-group" id="customerField">
        <label for="{{ form.customer.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
          {{ form.customer.label }}
        </label>
        {{ form.customer }}
      </div>
    </div>

    <!-- توضیحات -->
    <div class="form-group">
      <label for="{{ form.description.id_for_label }}" class="block text-sm font-medium text-gray-700 mb-1">
        {{ form.description.label }}
      </label>
      {{ form.description }}
    </div>

    <div class="flex justify-end space-x-4 pt-4">
      <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition duration-200">
        ذخیره دریافت
      </button>
      <a href="{% url 'home' %}" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-2 rounded-lg transition duration-200">
        انصراف
      </a>
    </div>
  </form>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
  // عناصر مورد نیاز
  const receiptTypeSelect = document.getElementById("id_receipt_type");
  const customerField = document.getElementById("customerField");
  const sourceTypeSelect = document.getElementById("id_source_type");
  const bankField = document.getElementById("bankField");

  // داده‌های مورد نیاز از مدل‌ها
  const receiptTypeData = {
    {% for rt in form.receipt_type.field.queryset %}
      "{{ rt.id }}": {"is_customer": {{ rt.is_customer|yesno:"true,false" }}},
    {% endfor %}
  };

  const sourceTypeData = {
    {% for st in form.source_type.field.queryset %}
      "{{ st.id }}": {"requires_bank": {{ st.requires_bank|yesno:"true,false" }}},
    {% endfor %}
  };

  // تابع برای بررسی نوع دریافت و نمایش/مخفی کردن فیلد مشتری
  function toggleCustomerField() {
    const selectedReceiptTypeId = receiptTypeSelect.value;
    
    if (selectedReceiptTypeId && receiptTypeData[selectedReceiptTypeId]?.is_customer) {
      customerField.style.display = "block";
    } else {
      customerField.style.display = "none";
      document.getElementById("id_customer").value = "";
    }
  }

  // تابع برای بررسی نوع منبع و نمایش/مخفی کردن فیلد بانک
  function toggleBankField() {
    const selectedSourceTypeId = sourceTypeSelect.value;
    
    if (selectedSourceTypeId && sourceTypeData[selectedSourceTypeId]?.requires_bank) {
      bankField.style.display = "block";
    } else {
      bankField.style.display = "none";
      document.getElementById("id_bank").value = "";
    }
  }

  // رویدادهای تغییر
  receiptTypeSelect.addEventListener("change", toggleCustomerField);
  sourceTypeSelect.addEventListener("change", toggleBankField);

  // مقداردهی اولیه
  toggleCustomerField();
  toggleBankField();

  // Persian Datepicker برای فیلد تاریخ
  $("#id_date").persianDatepicker({
      format: 'YYYY/MM/DD',
      autoClose: true,
      initialValue: false
  });
});
</script>
{% endblock %}
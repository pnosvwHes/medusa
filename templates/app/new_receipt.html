{% extends "app/base.html" %}
{% load static %}
{% load humanize %}

{% block content %}


<div class="max-w-2xl mx-auto p-6 bg-white rounded-xl shadow-md mt-6 form-data">
  <h1 class="text-2xl font-bold text-center mb-6 text-gray-800">ثبت دریافت جدید</h1>

  <form method="POST" id="receiptForm" class="space-y-4 form-data" >
    {% csrf_token %}
   {% comment %} {% if form.errors %}
  <div class="text-red-600 mb-4">
    لطفا خطاهای زیر را اصلاح کنید:
    <ul>
      {% for field in form %}
        {% if field.errors %}
          <li>
            <strong>{{ field.label }}:</strong> {{ field.errors|join:", " }}
            {% if field.data %}
              (مقدار وارد شده: {{ field.data }})
            {% endif %}
          </li>
        {% endif %}
      {% endfor %}
    </ul>
  </div>
{% endif %} {% endcomment %}

    <!-- تاریخ و مبلغ -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="form-group">
        <label for="{{ form.date.id_for_label }}">{{ form.date.label }}</label>
        {{ form.date }}
      </div>
      <div class="form-group">
        <label for="{{ form.amount.id_for_label }}">{{ form.amount.label }}</label>
        <input type="text" name="{{ form.amount.name }}" id="{{ form.amount.id_for_label }}" 
               value="{{ form.amount.value|default_if_none:''|intcomma }}"
               class="form-input price-field"
               inputmode="numeric"
               pattern="[0-9,]*">
      </div>
    </div>

    <!-- نوع منبع و بانک -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="form-group">
        <label for="{{ form.source_type.id_for_label }}">{{ form.source_type.label }}</label>
        {{ form.source_type }}
      </div>
      <div class="form-group" id="bankField">
        <label for="{{ form.bank.id_for_label }}">{{ form.bank.label }}</label>
        {{ form.bank }}
      </div>
    </div>

    <!-- نوع دریافت و مشتری -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="form-group">
        <label for="{{ form.receipt_type.id_for_label }}">{{ form.receipt_type.label }}</label>
        {{ form.receipt_type }}
      </div>
      <div class="form-group" id="customerField">
        <label for="{{ form.customer.id_for_label }}">{{ form.customer.label }}</label>
        {{ form.customer }}
      </div>
    </div>

    <!-- توضیحات -->
    <div class="form-group">
      <label for="{{ form.description.id_for_label }}">{{ form.description.label }}</label>
      {{ form.description }}
    </div>

    <div class="flex justify-end space-x-4 pt-4">
      <button type="submit" class="button primary">
        ذخیره دریافت
      </button>
      <a href="{% url 'home' %}" class="button secondary">
        انصراف
      </a>
    </div>
  </form>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const receiptTypeSelect = document.getElementById("id_receipt_type");
  const customerField = document.getElementById("customerField");
  const sourceTypeSelect = document.getElementById("id_source_type");
  const bankField = document.getElementById("bankField");
  const amountField = document.getElementById("id_amount");

  const receiptTypeData = {
    {% for rt in form.receipt_type.field.queryset %}
      "{{ rt.id }}": {"is_customer": {{ rt.is_customer|yesno:"true,false" }}},
    {% endfor %}
  };

  const sourceTypeData = {
    {% for st in form.source_type.field.queryset %}
      "{{ st.id }}": {"requires_bank": {{ st.requires_bank|yesno:"true,false" }}},
    {% endfor %}
  };

  function toggleCustomerField() {
    const selected = receiptTypeSelect.value;
    const customerSelect = $("#id_customer");

    if (selected && receiptTypeData[selected]?.is_customer) {
      customerField.style.display = "block";
      if (!customerSelect.hasClass("select2-hidden-accessible")) {
        customerSelect.select2({ width: "100%" });
      }
    } else {
      customerField.style.display = "none";
      customerSelect.val(null).trigger("change");
      if (customerSelect.hasClass("select2-hidden-accessible")) {
        customerSelect.select2("destroy");
      }
    }
  }

  function toggleBankField() {
    const selected = sourceTypeSelect.value;
    const bankSelect = $("#id_bank");

    if (selected && sourceTypeData[selected]?.requires_bank) {
      bankField.style.display = "block";
      if (!bankSelect.hasClass("select2-hidden-accessible")) {
        bankSelect.select2({ width: "100%" });
      }
    } else {
      bankField.style.display = "none";
      bankSelect.val(null).trigger("change");
      if (bankSelect.hasClass("select2-hidden-accessible")) {
        bankSelect.select2("destroy");
      }
    }
  }

  function formatNumber(input) {
    let value = input.value.replace(/,/g, '');
    if (!isNaN(value) && value.length > 0) {
      input.value = parseInt(value).toLocaleString('en-US');
    }
  }

  $(receiptTypeSelect).on('change.select2', toggleCustomerField);
  $(sourceTypeSelect).on('change.select2', toggleBankField);

  toggleCustomerField();
  toggleBankField();

  if (amountField) {
    amountField.addEventListener("input", function() {
      formatNumber(this);
    });
  }

  // Persian Datepicker
  $("#id_date").persianDatepicker({
      format: 'YYYY/MM/DD',
      autoClose: true,
      initialValue: false
  });

  // بررسی فرم قبل از submit
  document.getElementById("receiptForm").addEventListener("submit", function(e) {
    const selectedSource = sourceTypeSelect.value;
    const selectedReceipt = receiptTypeSelect.value;
    const bankValue = document.getElementById("id_bank").value;
    const customerValue = document.getElementById("id_customer").value;

    if (selectedSource && sourceTypeData[selectedSource]?.requires_bank && !bankValue) {
      e.preventDefault();
      alert("برای این نوع منبع، انتخاب حساب بانکی الزامی است");
      bankField.style.display = "block";
      document.getElementById("id_bank").focus();
      return;
    }

    if (selectedReceipt && receiptTypeData[selectedReceipt]?.is_customer && !customerValue) {
      e.preventDefault();
      alert("برای این نوع دریافت، انتخاب مشتری الزامی است");
      customerField.style.display = "block";
      document.getElementById("id_customer").focus();
      return;
    }

    // قبل از submit، کاماها را حذف کن
    if (amountField) {
      amountField.value = amountField.value.replace(/,/g, '');
    }
  });
});
</script>
{% endblock %}

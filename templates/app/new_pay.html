{% extends "app/base.html" %}
{% load static %}
{% load humanize %}

{% block content %}
<div class="max-w-2xl mx-auto p-4 bg-white rounded-xl shadow-md mt-6">
  <h1 class="text-2xl font-bold text-center mb-6 text-gray-800">ثبت دریافت جدید</h1>
  
  <form method="POST" id="receiptForm" class="space-y-6">
    {% csrf_token %}
    
    <!-- ردیف اول: تاریخ و مبلغ -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="form-group">
        <label for="id_date" class="block text-sm font-medium text-gray-700 mb-1">تاریخ</label>
        <input type="text" id="id_date" name="date" class="border p-2 rounded w-full">
      </div>

      <div class="form-group">
        <label for="id_amount" class="block text-sm font-medium text-gray-700 mb-1">مبلغ</label>
        <input type="number" id="id_amount" name="amount" class="border p-2 rounded w-full">
      </div>
    </div>

    <!-- ردیف دوم: نوع منبع و بانک -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="form-group">
        <label for="id_source_type" class="block text-sm font-medium text-gray-700 mb-1">به</label>
        <select id="id_source_type" name="source_type" class="border p-2 rounded w-full">
          {% for st in payment_methods %}
            <option value="{{ st.id }}" data-requires-bank="{{ st.requires_bank|yesno:'1,0' }}">{{ st.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group" id="bankField">
        <label for="id_bank" class="block text-sm font-medium text-gray-700 mb-1">حساب بانکی</label>
        <select id="id_bank" name="bank" class="border p-2 rounded w-full">
          {% for bank in banks %}
            <option value="{{ bank.id }}">{{ bank.name }}</option>
          {% endfor %}
        </select>
      </div>
    </div>

    <!-- ردیف سوم: نوع دریافت و مشتری -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
      <div class="form-group">
        <label for="id_receipt_type" class="block text-sm font-medium text-gray-700 mb-1">نوع دریافت</label>
        <select id="id_receipt_type" name="receipt_type" class="border p-2 rounded w-full">
          {% for rt in receipt_types %}
            <option value="{{ rt.id }}" data-is-customer="{{ rt.is_customer|yesno:'1,0' }}">{{ rt.name }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group" id="customerField">
        <label for="id_customer" class="block text-sm font-medium text-gray-700 mb-1">مشتری</label>
        <select id="id_customer" name="customer" class="border p-2 rounded w-full">
          {% for customer in customers %}
            <option value="{{ customer.id }}">{{ customer.name }}</option>
          {% endfor %}
        </select>
      </div>
    </div>

    <!-- توضیحات -->
    <div class="form-group">
      <label for="id_description" class="block text-sm font-medium text-gray-700 mb-1">توضیحات</label>
      <textarea id="id_description" name="description" class="border p-2 rounded w-full" rows="3"></textarea>
    </div>

    <div class="flex justify-end space-x-4 pt-4">
      <button type="submit" class="bg-blue-600 hover:bg-blue-700 text-white px-6 py-2 rounded-lg transition duration-200">
        ذخیره دریافت
      </button>
      <a href="{% url 'home' %}" class="bg-gray-200 hover:bg-gray-300 text-gray-800 px-6 py-2 rounded-lg transition duration-200">
        انصراف
      </a>
    </div>
  </form>
</div>

<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="{% static 'js/persian-datepicker.min.js' %}"></script>
<script>
$(document).ready(function() {
  // Initialize Persian Datepicker
  $("#id_date").persianDatepicker({
    format: 'YYYY/MM/DD',
    autoClose: true,
    initialValue: false
  });

  // تابع برای نمایش/مخفی کردن فیلدها
  function toggleFields() {
    // بررسی نوع منبع
    const sourceType = $("#id_source_type option:selected");
    const requiresBank = sourceType.data('requires-bank') === 1;
    $("#bankField").toggle(requiresBank);
    if (!requiresBank) $("#id_bank").val('');

    // بررسی نوع دریافت
    const receiptType = $("#id_receipt_type option:selected");
    const isCustomer = receiptType.data('is-customer') === 1;
    $("#customerField").toggle(isCustomer);
    if (!isCustomer) $("#id_customer").val('');
  }

  // رویدادهای تغییر
  $("#id_source_type, #id_receipt_type").change(toggleFields);

  // مقداردهی اولیه
  toggleFields();
});
</script>
{% endblock %}
{% extends "app/base.html" %}
{% load static %}
{% load humanize %}

{% block content %}
<div class="max-w-2xl mx-auto p-6 bg-white rounded-xl shadow-md mt-6 form-data">
  <h1 class="text-2xl font-bold text-center mb-6 text-gray-800">ثبت پرداخت جدید</h1>

  <form method="POST" id="paymentFormMain" class="space-y-4 form-data">
    {% csrf_token %}
   {% if form.errors %}
  <div class="text-red-600 mb-4">
    لطفا خطاهای زیر را اصلاح کنید:
    <ul>
      {% for field in form %}
        {% if field.errors %}
          <li>
            <strong>{{ field.label }}:</strong> {{ field.errors|join:", " }}
            {% if field.data %}
              (مقدار وارد شده: {{ field.data }})
            {% endif %}
          </li>
        {% endif %}
      {% endfor %}
    </ul>
  </div>
{% endif %}

    <!-- تاریخ و مبلغ -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="form-group">
        <label for="{{ form.date.id_for_label }}">{{ form.date.label }}</label>
        {{ form.date }}
      </div>
      <div class="form-group">
        <label for="{{ form.amount.id_for_label }}">{{ form.amount.label }}</label>
        <input type="text" name="{{ form.amount.name }}" id="{{ form.amount.id_for_label }}" 
               value="{{ form.amount.value|default_if_none:''|intcomma }}"
               class="form-input price-field"
               inputmode="numeric"
               pattern="[0-9,]*">
               
      </div>
    </div>

    <!-- نوع منبع و بانک -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="form-group">
        <label for="{{ form.source_type.id_for_label }}">{{ form.source_type.label }}</label>
        {{ form.source_type }}
      </div>
      <div class="form-group" id="bankField">
        <label for="{{ form.bank.id_for_label }}">{{ form.bank.label }}</label>
        {{ form.bank }}
      </div>
    </div>

    <!-- نوع پرداخت و پرسنل -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
      <div class="form-group">
        <label for="{{ form.pay_type.id_for_label }}">{{ form.pay_type.label }}</label>
        {{ form.pay_type }}
      </div>
      <div class="form-group" id="personnelField">
        <label for="{{ form.personnel.id_for_label }}">{{ form.personnel.label }}</label>
        {{ form.personnel }}
      </div>
    </div>

    <!-- توضیحات -->
    <div class="form-group">
      <label for="{{ form.description.id_for_label }}">{{ form.description.label }}</label>
      {{ form.description }}
    </div>

    <div class="flex justify-end space-x-4 pt-4">
      <button type="submit" class="button primary">
        ذخیره پرداخت
      </button>
      <a href="{% url 'home' %}" class="button secondary">
        انصراف
      </a>
    </div>
  </form>
</div>

<script>
document.addEventListener("DOMContentLoaded", function() {
  const payTypeSelect = document.getElementById("id_pay_type");
  const personnelField = document.getElementById("personnelField");
  const sourceTypeSelect = document.getElementById("id_source_type");
  const bankField = document.getElementById("bankField");
  const amountField = document.getElementById("id_amount");

  const payTypeData = {
    {% for pt in form.pay_type.field.queryset %}
      "{{ pt.id }}": {"is_personnel": {{ pt.is_personnel|yesno:"true,false" }}},
    {% endfor %}
  };

  const sourceTypeData = {
    {% for st in form.source_type.field.queryset %}
      "{{ st.id }}": {"requires_bank": {{ st.requires_bank|yesno:"true,false" }}},
    {% endfor %}
  };

  function togglePersonnelField() {
    const selected = payTypeSelect.value;
    const personnelSelect = $("#id_personnel");

    if (selected && payTypeData[selected]?.is_personnel) {
      personnelField.style.display = "block";
      if (!personnelSelect.hasClass("select2-hidden-accessible")) {
        personnelSelect.select2({ width: "100%" });
      }
    } else {
      personnelField.style.display = "none";
      personnelSelect.val(null).trigger("change");
      if (personnelSelect.hasClass("select2-hidden-accessible")) {
        personnelSelect.select2("destroy");
      }
    }
  }

  function toggleBankField() {
    const selected = sourceTypeSelect.value;
    const bankSelect = $("#id_bank");

    if (selected && sourceTypeData[selected]?.requires_bank) {
      bankField.style.display = "block";
      if (!bankSelect.hasClass("select2-hidden-accessible")) {
        bankSelect.select2({ width: "100%" });
      }
    } else {
      bankField.style.display = "none";
      bankSelect.val(null).trigger("change");
      if (bankSelect.hasClass("select2-hidden-accessible")) {
        bankSelect.select2("destroy");
      }
    }
  }

  function formatNumber(input) {
    let value = input.value.replace(/,/g, '');
    if (!isNaN(value) && value.length > 0) {
      input.value = parseInt(value).toLocaleString('en-US');
    }
  }

  $(payTypeSelect).on('change.select2', togglePersonnelField);
  $(sourceTypeSelect).on('change.select2', toggleBankField);

  togglePersonnelField();
  toggleBankField();

  if (amountField) {
    amountField.addEventListener("input", function() {
      formatNumber(this);
    });
  }

  // Persian Datepicker
  $("#id_date").persianDatepicker({
      format: 'YYYY/MM/DD',
      autoClose: true,
      initialValue: false
  });

  // بررسی فرم قبل از submit
  document.getElementById("paymentFormMain").addEventListener("submit", function(e) {
    const selectedSource = sourceTypeSelect.value;
    const selectedPay = payTypeSelect.value;
    const bankValue = document.getElementById("id_bank").value;
    const personnelValue = document.getElementById("id_personnel").value;

    if (selectedSource && sourceTypeData[selectedSource]?.requires_bank && !bankValue) {
      e.preventDefault();
      alert("برای این نوع منبع، انتخاب حساب بانکی الزامی است");
      bankField.style.display = "block";
      document.getElementById("id_bank").focus();
      return;
    }

    if (selectedPay && payTypeData[selectedPay]?.is_personnel && !personnelValue) {
      e.preventDefault();
      alert("برای این نوع پرداخت، انتخاب پرسنل الزامی است");
      personnelField.style.display = "block";
      document.getElementById("id_personnel").focus();
      return;
    }

    // قبل از submit، کاماها را حذف کن
    if (amountField) {
      amountField.value = amountField.value.replace(/,/g, '');
    }
  });
});
</script>
{% endblock %}

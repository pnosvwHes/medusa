{% extends "app/base.html" %}
{% load static %}

{% block extra_head %}
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
  #calendar {
    max-width: 1000px;
    margin: auto;
    background: #fff;
    border-radius: 8px;
    box-shadow: 0 0 10px rgba(0,0,0,0.1);
    padding: 10px;
    direction: rtl;
  }
  @media (max-width: 768px) {
    #calendar { padding: 5px; font-size: 14px; }
    .fc-header-toolbar { flex-direction: column; align-items: center; gap: 5px; }
    .fc-toolbar-title { font-size: 1.1em; margin: 5px 0; text-align: center; }
    .fc-button { padding: 0.3em 0.6em; font-size: 0.8em; margin: 2px; }
    .fc-timegrid-slot { height: 40px !important; font-size: 0.8em; }
    .fc-event { font-size: 0.75em; padding: 1px 2px; margin: 1px 0; }
    .filters { flex-direction: column; align-items: center; }
  }
  .select2-container { width: 100% !important; min-width: 200px; }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid py-3">
  <h2 class="text-center mb-3">تقویم رزرو آنلاین</h2>

  <div class="filters mb-3 d-flex flex-wrap gap-2 justify-content-center">
    <select id="search_personnel" class="form-select select2" aria-label="فیلتر پرسنل">
      <option value="">انتخاب پرسنل...</option>
      {% for personnel in personnel_list %}
        <option value="{{ personnel.id }}">{{ personnel.fname }} {{ personnel.lname }}</option>
      {% endfor %}
    </select>
  </div>

  <div id="calendar"></div>
</div>

<!-- Modal -->
<div class="modal fade" id="bookingModal" tabindex="-1" aria-labelledby="bookingModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <form id="bookingForm" class="modal-content">
      {% csrf_token %}
      <div class="modal-header bg-primary text-white">
        <h5 class="modal-title" id="bookingModalLabel">ثبت / ویرایش رزرو</h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
      </div>
      <div class="modal-body">
        <input type="hidden" id="booking_id" name="booking_id" value="" />

        <div class="mb-3">
          <label class="form-label">مشتری <span class="text-danger">*</span></label>
          <select id="modal_customer" name="customer_id" class="form-select select2-modal" required>
            {% for customer in customer_list %}
              <option value="{{ customer.id }}">{{ customer.name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label">خدمت</label>
          <select id="modal_work" name="work_id" class="form-select select2-modal">
            {% for work in work_list %}
              <option value="{{ work.id }}">{{ work.work_name }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="mb-3">
          <label class="form-label">پرسنل <span class="text-danger">*</span></label>
          <select id="modal_personnel" name="personnel_id" class="form-select select2-modal" required>
            {% for personnel in personnel_list %}
              <option value="{{ personnel.id }}">{{ personnel.fname }} {{ personnel.lname }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="row">
          <div class="col-md-6 mb-3">
            <label class="form-label">زمان شروع <span class="text-danger">*</span></label>
            <input type="text" id="modal_start" name="start_time" class="form-control" required autocomplete="off">
          </div>
          <div class="col-md-6 mb-3">
            <label class="form-label">زمان پایان <span class="text-danger">*</span></label>
            <input type="text" id="modal_end" name="end_time" class="form-control" required autocomplete="off">
          </div>
        </div>
      </div>
      <div class="modal-footer">
        <button type="button" id="deleteBtn" class="btn btn-danger me-auto d-none">حذف رزرو</button>
        <button type="submit" class="btn btn-primary">ذخیره</button>
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">انصراف</button>
      </div>
    </form>
  </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script src="https://cdn.jsdelivr.net/npm/jquery/dist/jquery.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/index.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.8/locales/fa.global.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/persian-date/dist/persian-date.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/persian-datepicker/dist/js/persian-datepicker.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
  const isMobile = window.matchMedia("(max-width: 768px)").matches;
  const calendarEl = document.getElementById('calendar');
  const bookingModal = new bootstrap.Modal(document.getElementById('bookingModal'));
  const bookingForm = document.getElementById('bookingForm');
  const deleteBtn = document.getElementById('deleteBtn');
  const personnelFilter = document.getElementById('search_personnel');
  let currentEvents = [];

  function initModalSelect2() {
    $('.select2-modal').select2({
      dir: 'rtl',
      width: '100%',
      dropdownParent: $('#bookingModal')
    });
  }

  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let cookie of cookies) {
        cookie = cookie.trim();
        if (cookie.startsWith(name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
  axios.defaults.headers.common['X-CSRFToken'] = getCookie('csrftoken');

  // تاریخ شمسی
  $('#modal_start').persianDatepicker({
    format: 'YYYY/MM/DD HH:mm',
    timePicker: { enabled: true, meridiem: { enabled: false } }
  });
  $('#modal_end').persianDatepicker({
    format: 'YYYY/MM/DD HH:mm',
    timePicker: { enabled: true, meridiem: { enabled: false } }
  });

  const calendar = new FullCalendar.Calendar(calendarEl, {
    locale: 'fa',
    initialView: isMobile ? 'timeGridDay' : 'timeGridWeek',
    selectable: true,
    editable: false,
    eventOverlap: false,
    selectOverlap: false,
    allDaySlot: false,
    slotMinTime: "08:00:00",
    slotMaxTime: "22:00:00",
    timeZone: 'local',
    selectMirror: true,
    dayMaxEvents: isMobile ? 3 : false,
    longPressDelay: 0, // برای فعال‌سازی تاچ سریع‌تر
    eventLongPressDelay: 0,
    touchStartThreshold: 1,
    firstDay: 6,
    events: function(fetchInfo, successCallback, failureCallback) {
      const personnelId = personnelFilter.value;
      if (!personnelId) return successCallback([]);
      axios.get(`/booking/appointments/?personnel_id=${personnelId}`)
        .then(res => {
          const events = res.data.map(ev => ({
            id: ev.id,
            title: ev.title || 'رزرو',
            start: ev.start,
            end: ev.end,
            backgroundColor: ev.isPaid ? '#28a745' : '#007bff',
            borderColor: ev.isPaid ? '#218838' : '#0069d9',
            textColor: '#fff',
            extendedProps: {
              customer_id: ev.customerId,
              work_id: ev.workId,
              personnel_id: ev.personnelId
            }
          }));
          currentEvents = events;
          successCallback(events);
        })
        .catch(err => failureCallback(err));
    },
    select: function(info) {
      const overlapping = currentEvents.some(ev =>
        (info.start < new Date(ev.end)) && (info.end > new Date(ev.start))
      );
      if (overlapping) { alert("این بازه قبلاً رزرو شده است."); return; }
      $('#booking_id').val('');
      $('#modal_customer').val('');
      $('#modal_work').val('');
      $('#modal_personnel').val(personnelFilter.value || '');
      $('#modal_start').val(new persianDate(info.start).format('YYYY/MM/DD HH:mm'));
      $('#modal_end').val(new persianDate(info.end).format('YYYY/MM/DD HH:mm'));
      deleteBtn.classList.add('d-none');
      initModalSelect2();
      bookingModal.show();
    },
    eventClick: function(info) {
      const ev = info.event;
      $('#booking_id').val(ev.id);
      $('#modal_customer').val(ev.extendedProps.customer_id);
      $('#modal_work').val(ev.extendedProps.work_id);
      $('#modal_personnel').val(ev.extendedProps.personnel_id);
      $('#modal_start').val(new persianDate(ev.start).format('YYYY/MM/DD HH:mm'));
      $('#modal_end').val(new persianDate(ev.end).format('YYYY/MM/DD HH:mm'));
      deleteBtn.classList.remove('d-none');
      initModalSelect2();
      bookingModal.show();
    }
  });

  calendar.render();

  $('#search_personnel').select2({ dir: 'rtl', width: '100%', placeholder: 'انتخاب پرسنل...' })
    .on('change', () => calendar.refetchEvents());

  bookingForm.addEventListener('submit', function(e) {
    e.preventDefault();
    const id = $('#booking_id').val();
    const url = id ? `/booking/update/${id}/` : `/booking/create/`;

    // تبدیل به میلادی قبل از ارسال
    const startGregorian = new persianDate($('#modal_start').val()).toGregorian();
    const endGregorian = new persianDate($('#modal_end').val()).toGregorian();

    const formData = new FormData(bookingForm);
    formData.set('start_time', `${startGregorian.year}-${String(startGregorian.month).padStart(2,'0')}-${String(startGregorian.day).padStart(2,'0')}T${$('#modal_start').val().split(' ')[1]}`);
    formData.set('end_time', `${endGregorian.year}-${String(endGregorian.month).padStart(2,'0')}-${String(endGregorian.day).padStart(2,'0')}T${$('#modal_end').val().split(' ')[1]}`);

    axios.post(url, formData).then(res => {
      if (res.data.status === 'success') {
        bookingModal.hide();
        calendar.refetchEvents();
      } else {
        alert('خطا در ثبت رزرو');
      }
    });
  });

  deleteBtn.addEventListener('click', function() {
    if (!confirm('حذف شود؟')) return;
    const id = $('#booking_id').val();
    axios.post(`/booking/delete/${id}/`).then(res => {
      if (res.data.status === 'success') {
        bookingModal.hide();
        calendar.refetchEvents();
      } else { alert('خطا در حذف رزرو'); }
    });
  });
});
</script>
{% endblock %}
